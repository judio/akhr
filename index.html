<!DOCTYPE html>

<html lang="ko" xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <title>明日方舟公开招募计算器</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css" integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js" integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js" integrity="sha384-wfSDF2E50Y2D1uUdj0O3uMBJnjuUD4Ih7YwaYd1iqfktj0Uod8GCExl3Og8ifwB6" crossorigin="anonymous"></script>
</head>
<body>
    <nav class="navbar navbar-expand-md navbar-dark bg-dark">
        <a class="navbar-brand ko" href="/">명일방주 도우미</a>
        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav"
                aria-controls="navbarNav" aria-expanded="false" aria-label="展开">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse justify-content-between" id="navbarNav">
            <ul class="navbar-nav">
                <li class="nav-item active">
                    <a class="nav-link ko" href="index.html?lang=ko">공개모집 계산기</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link disabled ko" href="#">레벨 계산기</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link disabled ko" href="#">정예화 계산기</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link disabled ko" href="#">대원목록</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link disabled ko" href="#">개발중...</a>
                </li>
            </ul>
        </div>
    </nav>
    <div class="container" style="margin:auto;max-width:1000px;">
        <div class="col-12 alert alert-dark mt-3 p-1 p-sm-2" role="alert">
            <table class="table table-sm m-0 mx-sm-1" id="box-options">
                <tr>
                    <td>
                        <button type="button" class="btn btn-sm btn-danger my-1" id="btn-clear">
                            <span class="ko">초기화</span>
                        </button>
                        <span class="d-none d-sm-inline">
                            <button type="button" class="btn btn-sm btn-primary btn-showopt my-1 btn-name" opt-id="showName">
                                <span class="ko">이름</span>
                            </button>
                            <button type="button" class="btn btn-sm btn-primary btn-showopt my-1 btn-image" opt-id="showImage">
                                <span class="ko">이미지</span>
                            </button>
                            <button type="button" class="btn btn-sm btn-primary btn-showopt my-1 btn-imgsize btn-imgsizedefault" sizeval="27">
                                <span class="ko">소</span>
                            </button>
                            <button type="button" class="btn btn-sm btn-secondary btn-showopt my-1 btn-imgsize" sizeval="45">
                                <span class="ko">중</span>
                            </button>
                            <button type="button" class="btn btn-sm btn-secondary btn-showopt my-1 btn-imgsize" sizeval="80">
                                <span class="ko">대</span>
                            </button>
                            <button type="button" class="btn btn-sm btn-secondary btn-showopt my-1 btn-imgsize" sizeval="128">
                                <span class="ko">특대</span>
                            </button>
                        </span>
                    </td>
                </tr>
                <tr>
                    <td>
                        <button type="button" class="btn btn-sm btn-primary btn-opt my-1" opt-id="all" id="opt-all">ALL</button>
                        <button type="button" class="btn btn-sm btn-primary btn-opt my-1" opt-id="6">6★</button>
                        <button type="button" class="btn btn-sm btn-primary btn-opt my-1" opt-id="5">5★</button>
                        <button type="button" class="btn btn-sm btn-primary btn-opt my-1" opt-id="4">4★</button>
                        <button type="button" class="btn btn-sm btn-primary btn-opt my-1" opt-id="3">3★</button>
                        <button type="button" class="btn btn-sm btn-primary btn-opt my-1" opt-id="2">2★</button>
                        <button type="button" class="btn btn-sm btn-primary btn-opt my-1" opt-id="1">1★</button>

                    </td>
                </tr>
            </table>
            <table class="table table-sm m-0 mx-sm-1" id="box-tags"></table>
        </div>
        <table class="table table-striped table-hover my-3" id="table-recommend">
            <thead class="thead-dark">
                <tr>
                    <th scope="col" class="d-none d-sm-table-cell">#</th>
                    <th scope="col" style="width:16.67%">Tags</th>
                    <th scope="col">
                        <span class="ko">출현 가능한 대원</span>
                    </th>
                    <th scope="col" class="d-none d-sm-table-cell">$~</th>
                </tr>
            </thead>
            <tbody id="tbody-recommend"></tbody>
        </table>
        <hr />
        <div class="row col-12 tutorial">
            <div class="col-12 text-left ko">
                <p>사용방법:</p>
                <p>1. 태그를 6개 까지 클릭해주세요</p>
                <p>2. 필터링하고싶은 레어도를 선택하세요</p>
                <p>3. 클릭하면 현재 페이지에 자동으로 계산됩니다</p>
                <p>4. 대원의 이름이나 이미지를 클릭해서 정확한 조건이 무엇인지 확인할 수 있습니다. 다른 대원의 이름이나 이미지를 클릭하면 돌아옵니다.</p>
            </div>
        </div>
        <div class="col-12 alert alert-success mt-1 cn" role="alert">
            test。<br />
            1234。
        </div>
    </div>

    <hr />
    <div class="row col-12 page-footer">
    </div>
    <script>
        $(function () {
            let lang = "ko";
            document.title = {
                "ko": "명일방주 공개모집 계산기"
            }[lang];
            let tags = [
                {
                    "ko": "자격", "kotags": ["신입", "베테랑", "전문가"]
                },
                {
                    "ko": "포지션", "kotags": ["원거리", "근거리"]
                },
                {
                    "ko": "성별", "kotags": ["남성", "여성"]
                },
                {
                    "ko": "클래스", "kotags": ["선봉", "저격대원", "의료대원", "술사대원", "근위대원", "중장대원", "보조대원", "특수대원"]
                },
                {
                    "ko": "태그", "kotags": ["치료", "지원", "딜링", "광역", "슬로우", "생존", "보호", "약화", "변위", "군중제어", "폭발", "소환", "쾌속부활", "비용회복"]
                }
            ];
            $.each(tags, (_, v) => {
                let row = '<tr><td><button class="btn btn-sm btn-info my-1" disabled>' + v[lang] + '</button></td><td>';
                let tags_btn = []
                for (let i = 0; i < v['kotags'].length; i++) {
                    tags_btn.push('<button class="btn btn-sm btn-secondary btn-tag m-1" ' +
                        (lang === 'cn' ? '' : ('data-toggle="tooltip" data-placement="top" title="' + v[lang + 'tags'][i] + '"'))
                        + '>' + v['kotags'][i] + "</button>");
                }
                row += tags_btn.join("") + "</td></tr>";
                $("#box-tags").append(row);
            });
            if (lang !== 'cn') $('[data-toggle="tooltip"]').tooltip();

            let showImage = false;
            let showName = true;
            let imageSize = 27;
            $(document).on("click", ".btn-name", function () {
                $(this).toggleClass("btn-primary btn-secondary");
                showName = !showName;
                calc();
            });
            $(document).on("click", ".btn-image", function () {
                $(this).toggleClass("btn-primary btn-secondary");
                $(".btn-imgsize").removeClass("btn-primary btn-secondary").addClass("btn-secondary");
                if ($(this).hasClass("btn-primary"))
                    $(".btn-imgsize[sizeval=" + imageSize + "]").toggleClass("btn-primary btn-secondary");
                showImage = !showImage;
                calc();
            });
            $(document).on("click", ".btn-imgsize", function () {
                imageSize = parseInt($(this).attr("sizeval"));
                $(".btn-imgsize").removeClass("btn-primary btn-secondary").addClass("btn-secondary");
                $(this).toggleClass("btn-primary btn-secondary");
                calc();
            });

            let tags_aval = {};
            let all_chars = {};
            let avg_char_tag = 0;
            $.getJSON("akhr.json", function (data) {
                let tag_count = 0;
                let char_tag_sum = 0;
                // console.log(data);
                $.each(data, function (_, char) {
                    if (char.hidden) return;
                    char.tags.push(char.type);
                    char.tags.push(char.sex);
                    let name = lang === 'cn' ? char.name : char["name-" + lang];
                    $.each(char.tags, function (_, tag) {
                        if (tag in tags_aval) {
                            tags_aval[tag].push({ "name": name, "img": char["name-en"], "level": char.level, "type": char.type });
                        } else {
                            tags_aval[tag] = [{ "name": name, "img": char["name-en"], "level": char.level, "type": char.type }];
                            tag_count++;
                        }
                        char_tag_sum++;
                    });
                    all_chars[name] = { 'level': char.level, 'tags': char.tags };
                });
                avg_char_tag = char_tag_sum / tag_count;
            });

            function calc() {
                let len = checkedTags.length;
                let count = Math.pow(2, checkedTags.length);
                let combs = [];
                for (let i = 0; i < count; i++) {
                    let ts = [], tsTL = [];
                    for (let j = 0, mask = 1; j < len; j++) {
                        if ((i & mask) !== 0) {
                            ts.push(checkedTags[j]);
                            tsTL.push(checkedTagsTL[j]);
                            // console.log(checkedTags[j]);
                        }
                        mask = mask * 2;
                    }
                    combs.push({ "tags": ts, "tagsTL": tsTL, "score": 0.0, "possible": [] });
                }
                // console.log(combs);
                let optStars = [];
                $(".btn-opt").each(function (_, __) {
                    if ($(this).attr("opt-id") === "all" || $(this).hasClass("btn-secondary")) return;
                    optStars.push($(this).attr("opt-id"));
                });
                //console.log(optStars);
                $("#tbody-recommend").html("");
                $.each(combs, function (_, comb) {
                    let tags = comb.tags;
                    if (tags.length === 0 || tags.length > 3) return;
                    let chars = [...tags_aval[tags[0]]];
                    for (let i = 1; i < tags.length; i++) {
                        let reduced_chars = [];
                        $.each(chars, function (_, char) {
                            // console.log(tags_aval[tags[i]]);
                            // console.log(char);
                            $.each(tags_aval[tags[i]], function (_, tgch) {
                                if (char.name === tgch.name) {
                                    reduced_chars.push(char);
                                    return false;
                                }
                            });
                        });
                        chars = reduced_chars;
                    }

                    if (chars.length === 0) return;
                    if (!tags.includes("전문가")) {
                        // console.log(tags.join(",") + " 不含(高级)资深干员");
                        let reduce6 = [];
                        $.each(chars, function (_, char) {
                            if (char.level !== 6) {
                                reduce6.push(char);
                            }
                        });
                        chars = reduce6;
                    }
                    let filtered_chars = [];
                    $.each(chars, function (_, char) {
                        //console.log(char.level);
                        if (optStars.includes(char.level.toString())) {
                            filtered_chars.push(char);
                        }
                    });
                    chars = filtered_chars;

                    comb.possible = chars;
                    if (chars.length === 0) return;
                    let s = 0;
                    $.each(chars, (_, char) => {
                        s += char.level;
                    });
                    s = s / chars.length;
                    comb.score = s + tags.length / 10 - chars.length / avg_char_tag;
                });
                combs.sort(function (a, b) {
                    return a.score > b.score ? -1 : (a.score < b.score ? 1 :
                        (a.tags.length > b.tags.length ? 1 : (a.tags.length < b.tags.length ? -1 : 0)));
                });
                let no = 1;
                $.each(combs, function (_, comb) {
                    if (comb.possible.length === 0) return;
                    let chars = comb.possible;
                    let tags = comb.tags;
                    let tagsTL = comb.tagsTL;
                    let chars_html = [];
                    let colors = { 1: "dark", 2: "light", 3: "success", 4: "info", 5: "warning", 6: "danger" };
                    comb.possible.sort(function (a, b) {
                        return a.level > b.level ? -1 : (a.level < b.level ? 1 : 0);
                    });
                    $.each(chars, function (_, char) {
                        let padding = showName && imageSize < 60 ? "padding-right: 4px" : "padding-right: 1px";
                        let style = showImage ? "style=\"border-radius: 5px;padding: 1px 1px;" + padding + ";\" " : "";
                        let buttonstyle = imageSize > 25 ? "background-color: #AAA;border-radius: 4px;" : "background-color: transparent;border-radius: 4px;";
                        chars_html.push("<button type=\"button\" class=\"btn btn-sm btn-" + colors[char.level] + " btn-char my-1 d-none d-sm-inline\" " + style + "title=\"" + char.name + "\">");
                        if (showImage) chars_html.push("<img style=\"" + buttonstyle + "\"height=\"" + imageSize + "\" width=\"" + imageSize + "\" src=\"img/chara/" + char.img + ".png\">   ");
                        if (imageSize > 60) chars_html.push("<div>");
                        if (showName) chars_html.push(char.name);
                        if (imageSize > 60) chars_html.push("</div>");
                        chars_html.push("</button>\n");
                        chars_html.push("<button type=\"button\" class=\"btn btn-sm btn-" + colors[char.level] + " btn-char my-1 d-inline d-sm-none\" " + "title=\"" + char.name + "\">" + char.name + "</button>\n");
                    });
                    let tags_html = [];
                    for (let i = 0; i < tags.length; i++) {
                        if (lang === 'cn') {
                            tags_html.push('<button type="button" class="btn btn-sm btn-secondary btn-char my-1">' +
                                tags[i] + "</button>\n");
                        } else {
                            tags_html.push('<button type="button" class="btn btn-sm btn-secondary btn-char my-1' +
                                ' btn-char my-1" data-toggle="tooltip" data-placement="top" title="' + tagsTL[i] + '">' +
                                tags[i] + "</button>\n");
                        }
                    }
                    $("#tbody-recommend").append(
                        "<tr class=\"tr-recommd\">" +
                        "<td class=\"py-2 d-none d-sm-table-cell\">" + no++ + "</td>" +
                        "<td class=\"py-1\">" + tags_html.join("") + "</td><td class=\"py-1\">" + chars_html.join("") +
                        "</td>" + 
                        "<td class=\"py-2 d-none d-sm-table-cell\">" + Math.floor(comb.score * 100) / 100 + "</td>" +
                        "</tr>");

                });
                if (lang !== 'cn') $('[data-toggle="tooltip"]').tooltip();
            }

            let hasHidden = false;
            $(document).on("click", ".btn-char", function () {
                if (!hasHidden) {
                    let char_name = $(this).attr("title");
                    $(".tr-recommd:not(:contains('" + char_name + "'))").hide();
                    let char = all_chars[char_name];
                    let colors = { 1: "dark", 2: "light", 3: "success", 4: "info", 5: "warning", 6: "danger" };

                    let tags_html = [];
                    $.each(char.tags, function (_, tag) {
                        tags_html.push("<button type=\"button\" class=\"btn btn-sm btn-secondary btn-char my-1\">" +
                            tag + "</button>\n")
                    });
                    $("#tbody-recommend").append(
                        "<tr class=\"tr-chartag\">"+ 
                        "<td class=\"py-2 d-none d-sm-table-cell\">#</td>" + 
                        "<td class=\"py-1\"><button type=\"button\" class=\"btn btn-sm btn-" + colors[char.level] +
                        " btn-char my-1\">" + char_name + "</button>\n" +
                        "</td><td class=\"py-1\">" + tags_html.join("") +
                        "</td><td class=\"py-2 d-none d-sm-table-cell\">#</td></tr>");
                } else {
                    $(".tr-recommd").show();
                    $(".tr-chartag").remove();
                }
                hasHidden = !hasHidden;
            });

            let checkedTags = [];
            let checkedTagsTL = [];
            $(document).on("click", ".btn-tag", function () {
                let checked = $(this).hasClass("btn-primary");
                let tag = $(this).text();
                let tagTL = $(this).attr("data-original-title");
                if (checked) {
                    checkedTags = checkedTags.filter(function (v, _, __) {
                        return v !== tag;
                    });
                    checkedTagsTL = checkedTagsTL.filter(function (v, _, __) {
                        return v !== tagTL;
                    });
                } else {
                    if (checkedTags.length >= 6) {
                        alert({ "cn": "无法选择更多标签：最多6个。", "en": "No more tags: max 6." }[lang]);
                        return;
                    } else {
                        checkedTags.push(tag);
                        checkedTagsTL.push(tagTL);
                    }
                }
                $(this).toggleClass("btn-primary btn-secondary");
                calc();
            });
            $(document).on("click", ".btn-opt", function () {
                $(this).toggleClass("btn-primary btn-secondary");
                let checked = $(this).hasClass("btn-primary");
                if ($(this).attr("id") === "opt-all") {
                    $(".btn-opt").removeClass("btn-primary btn-secondary").addClass(
                        checked ? "btn-primary" : "btn-secondary"
                    );
                } else {
                    if ($("#opt-all").hasClass("btn-primary")) {
                        $("#opt-all").toggleClass("btn-primary btn-secondary");
                    } else {
                        let checkedCount = 0;
                        $(".btn-opt").each(function (_, __) {
                            if ($(this).attr("id") === "opt-all") return;
                            if ($(this).hasClass("btn-primary")) checkedCount++;
                        });
                        if (checkedCount === 6) $("#opt-all").toggleClass("btn-primary btn-secondary");
                    }
                }
                calc();
            });

            $(document).on('click', '#btn-clear', function () {
                $('.btn-tag').removeClass('btn-primary').addClass('btn-secondary');
                $("#tbody-recommend").html("");
                checkedTags = [];
            });
        });
    </script>
</body>
</html>